(function(){"use strict";var U=(t=>(t[t.None=0]="None",t[t.Black=1]="Black",t[t.White=2]="White",t[t.Obstacle=3]="Obstacle",t))(U||{}),d=(t=>(t.Easy="easy",t.Medium="medium",t.Hard="hard",t))(d||{});const H=13,$=H*H,m=new Int16Array($*4);let g,N=0;const j=t=>{if(N!==t){N=t,m.fill(-1);for(let c=0;c<t;c++)for(let n=0;n<t;n++){const o=c*t+n;c>0&&(m[o*4+0]=(c-1)*t+n),c<t-1&&(m[o*4+1]=(c+1)*t+n),n>0&&(m[o*4+2]=c*t+(n-1)),n<t-1&&(m[o*4+3]=c*t+(n+1))}g=new BigUint64Array(t*t*4);for(let c=0;c<g.length;c++){const n=BigInt(Math.floor(Math.random()*4294967295)),o=BigInt(Math.floor(Math.random()*4294967295));g[c]=n<<32n|o}}},_=(t,c)=>({r:Math.floor(t/c),c:t%c});let l,v,T,F;const k=1<<20,J=BigInt(k-1),M={hashes:new BigUint64Array(k),depths:new Int8Array(k),flags:new Uint8Array(k),scores:new Int32Array(k),bestMoves:new Int16Array(k)},W=1,Z=2,q=3,K=Array.from({length:30},()=>[]),P=t=>{let c=0n;for(let n=0;n<t*t;n++){const o=l[n];o!==0&&(c^=g[n*4+o])}return c},R=(t,c,n)=>{let o=0,s=0;for(T[s++]=t,v[t]=1;o<s;){const f=T[o++];if(c===1){let e=f,r=!1;for(;e=m[e*4+0],e!==-1;)if(l[e]!==0){r=!0;break}if(!r)return!0;for(e=f,r=!1;e=m[e*4+1],e!==-1;)if(l[e]!==0){r=!0;break}if(!r)return!0}else{let e=f,r=!1;for(;e=m[e*4+2],e!==-1;)if(l[e]!==0){r=!0;break}if(!r)return!0;for(e=f,r=!1;e=m[e*4+3],e!==-1;)if(l[e]!==0){r=!0;break}if(!r)return!0}for(let e=0;e<4;e++){let r=f;for(;r=m[r*4+e],r!==-1;){const i=l[r];if(i!==0){i===c&&v[r]!==1&&(v[r]=1,T[s++]=r);break}}}}return!1},x=(t,c,n)=>{const o=Math.floor(t/n),s=t%n;let f=1,e=t+1;for(;e%n>s&&e<n*n&&l[e]===c;)f++,e++;for(e=t-1;e%n<s&&e>=0&&l[e]===c;)f++,e--;if(f>=4)return!0;for(f=1,e=t+n;e<n*n&&l[e]===c;)f++,e+=n;for(e=t-n;e>=0&&l[e]===c;)f++,e-=n;if(f>=4)return!0;f=1,e=t+n+1;let r=o+1,i=s+1;for(;r<n&&i<n&&l[e]===c;)f++,e+=n+1,r++,i++;for(e=t-n-1,r=o-1,i=s-1;r>=0&&i>=0&&l[e]===c;)f++,e-=n+1,r--,i--;if(f>=4)return!0;for(f=1,e=t+n-1,r=o+1,i=s-1;r<n&&i>=0&&l[e]===c;)f++,e+=n-1,r++,i--;for(e=t-n+1,r=o-1,i=s+1;r>=0&&i<n&&l[e]===c;)f++,e-=n+1,r--,i++;return f>=4},D=(t,c,n,o)=>{if(l[t]!==0)return{success:!1,hashDiff:0n,capturedCount:0};if(x(t,c,n))return{success:!1,hashDiff:0n,capturedCount:0};l[t]=c;let s=g[t*4+c];const f=c===1?2:1,e=K[o];e.length=0;for(let r=0;r<n*n;r++)l[r]===f&&(v.fill(0),R(r,f)||p(r,f,n,e));for(const r of e)l[r]=0,s^=g[r*4+f];if(v.fill(0),!R(t,c)){for(const r of e)l[r]=f;return l[t]=0,{success:!1,hashDiff:0n,capturedCount:0}}return{success:!0,hashDiff:s,capturedCount:e.length}},B=(t,c,n)=>{l[t]=0;const o=c===1?2:1,s=K[n];for(const f of s)l[f]=o},p=(t,c,n,o)=>{let s=0,f=0;const e=F;if(e[f++]=t,o.includes(t))return;o.push(t);const r=new Uint8Array(n*n);for(r[t]=1;s<f;){const i=e[s++];for(let a=0;a<4;a++){let u=i;for(;u=m[u*4+a],u!==-1;){const h=l[u];if(h!==0){h===c&&r[u]===0&&(r[u]=1,o.includes(u)||(o.push(u),e[f++]=u));break}}}}},V=(t,c)=>{let n=0,o=0;const s=t/2;for(let f=0;f<t*t;f++){const e=l[f];if(e===0||e===3)continue;let r=100;const i=Math.floor(f/t),a=f%t,u=Math.abs(i-s)+Math.abs(a-s);r+=(t-u)*2;for(let h=0;h<4;h++){let b=m[f*4+h];b===-1?r+=30:l[b]===0&&(r+=2)}e===c?n+=r:o+=r}return n-o},G=(t,c,n)=>{const o=t/2;if(n!==0){const s=c.indexOf(n);s>0&&(c[s]=c[0],c[0]=n)}c.sort((s,f)=>{if(s===n)return-1;if(f===n)return 1;const e=Math.abs(Math.floor(s/t)-o)+Math.abs(s%t-o),r=Math.abs(Math.floor(f/t)-o)+Math.abs(f%t-o);return e-r})},S=t=>{const c=[];for(let n=0;n<t*t;n++)l[n]===0&&c.push(n);return c};let A=0,E=0,O=0;const Q=(t,c,n,o,s)=>{if(A++,(A&2047)===0&&Date.now()>E)return-999999;const f=V(t,o);if(f>=n)return n;if(c<f&&(c=f),s>=4)return f;const e=S(t);G(t,e,0);for(const r of e){const{success:i,capturedCount:a}=D(r,o,t,20+s);if(i){if(a===0){B(r,o,20+s);continue}const u=-Q(t,-n,-c,o===1?2:1,s+1);if(B(r,o,20+s),u===999999)return-999999;if(u>=n)return n;u>c&&(c=u)}}return c},X=(t,c,n,o,s,f,e)=>{if(A++,(A&2047)===0&&Date.now()>E)return-999999;const r=Number(e&J),i=M.hashes[r];let a=0;if(i===e&&M.depths[r]>=c){const w=M.flags[r],I=M.scores[r];if(a=M.bestMoves[r],w===W||(w===Z?n=Math.max(n,I):w===q&&(o=Math.min(o,I)),n>=o))return I}if(c===0)return Q(t,n,o,s,0);const u=S(t);G(t,u,a),f&&(O=0);let h=-1/0,b=0,Y=!1,L=q;for(const w of u){const{success:I,hashDiff:z}=D(w,s,t,c);if(I){Y=!0;const C=-X(t,c-1,-o,-n,s===1?2:1,!1,e^z);if(B(w,s,c),C===999999)return-999999;if(C>h?(h=C,b=w,f&&(M.bestMoves[0]=w,O=1)):f&&C===h&&(O++,Math.random()<1/O&&(b=w,M.bestMoves[0]=w)),n=Math.max(n,h),n>=o){L=Z;break}}}return Y?(h!==-999999&&(h>n&&h<o&&(L=W),M.depths[r]<=c&&(M.hashes[r]=e,M.scores[r]=h,M.flags[r]=L,M.depths[r]=c,M.bestMoves[r]=b)),h):V(t,s)},y=async(t,c,n)=>{const o=t.length;j(o),(!l||l.length!==o*o)&&(l=new Int8Array(o*o),v=new Uint8Array(o*o),T=new Int16Array(o*o),F=new Int16Array(o*o));for(let a=0;a<o;a++)for(let u=0;u<o;u++)l[a*o+u]=t[a][u];A=0;const s=c===U.Black?1:2,f=P(o),e=n===d.Hard?1200:n===d.Medium?400:100;E=Date.now()+e;let r=-1,i=n===d.Hard?8:n===d.Medium?4:2;if(n===d.Easy&&Math.random()<.25){const a=S(o);if(a.length>0){const u=a[Math.floor(Math.random()*Math.min(a.length,8))];return _(u,o)}}console.log(`AI Thinking (${n})...`);for(let a=1;a<=i;a++){if(X(o,a,-1/0,1/0,s,!0,f)===-999999){console.log("Time out at depth",a);break}if(M.bestMoves[0]!==0&&(r=M.bestMoves[0]),Date.now()>E)break}if(r===-1||r===0){const a=S(o);for(const u of a){const{success:h}=D(u,s,o,0);if(h)return B(u,s,0),_(u,o)}return null}return _(r,o)};self.onmessage=async t=>{const{board:c,player:n,difficulty:o}=t.data,s=await y(c,n,o);self.postMessage(s)}})();
