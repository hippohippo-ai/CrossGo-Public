(function(){"use strict";var L=(t=>(t[t.None=0]="None",t[t.Black=1]="Black",t[t.White=2]="White",t[t.Obstacle=3]="Obstacle",t))(L||{}),B=(t=>(t.Easy="easy",t.Medium="medium",t.Hard="hard",t))(B||{});let b=169;const d=new Int16Array(2e3);let m,U=0;const Q=t=>{if(U!==t){U=t,b=t*t,d.fill(-1);for(let s=0;s<t;s++)for(let e=0;e<t;e++){const o=s*t+e;s>0&&(d[o*4+0]=(s-1)*t+e),s<t-1&&(d[o*4+1]=(s+1)*t+e),e>0&&(d[o*4+2]=s*t+(e-1)),e<t-1&&(d[o*4+3]=s*t+(e+1))}m=new BigUint64Array(t*t*4);for(let s=0;s<m.length;s++){const e=BigInt(Math.floor(Math.random()*4294967295)),o=BigInt(Math.floor(Math.random()*4294967295));m[s]=e<<32n|o}}},_=(t,s)=>({r:Math.floor(t/s),c:t%s});let a,v,S,p;const k=1<<19,X=BigInt(k-1),M={hashes:new BigUint64Array(k),depths:new Int8Array(k),flags:new Uint8Array(k),scores:new Int32Array(k),bestMoves:new Int16Array(k)},H=1,N=2,W=3,q=Array.from({length:30},()=>[]),Y=t=>{let s=0n;for(let e=0;e<t*t;e++){const o=a[e];o!==0&&(s^=m[e*4+o])}return s},F=(t,s)=>{let e=0,o=0;for(S[o++]=t,v[t]=1;e<o;){const c=S[e++];if(s===1){let n=c,r=!1;for(;n=d[n*4+0],n!==-1;)if(a[n]!==0){r=!0;break}if(!r)return!0;for(n=c,r=!1;n=d[n*4+1],n!==-1;)if(a[n]!==0){r=!0;break}if(!r)return!0}else{let n=c,r=!1;for(;n=d[n*4+2],n!==-1;)if(a[n]!==0){r=!0;break}if(!r)return!0;for(n=c,r=!1;n=d[n*4+3],n!==-1;)if(a[n]!==0){r=!0;break}if(!r)return!0}for(let n=0;n<4;n++){let r=c;for(;r=d[r*4+n],r!==-1;){const f=a[r];if(f!==0){f===s&&v[r]!==1&&(v[r]=1,S[o++]=r);break}}}}return!1},j=(t,s,e)=>{const o=Math.floor(t/e),c=t%e;let n=1,r=t+1;for(;r%e>c&&r<b&&a[r]===s;)n++,r++;for(r=t-1;r%e<c&&r>=0&&a[r]===s;)n++,r--;if(n>=4)return!0;for(n=1,r=t+e;r<b&&a[r]===s;)n++,r+=e;for(r=t-e;r>=0&&a[r]===s;)n++,r-=e;if(n>=4)return!0;n=1,r=t+e+1;let f=o+1,u=c+1;for(;f<e&&u<e&&a[r]===s;)n++,r+=e+1,f++,u++;for(r=t-e-1,f=o-1,u=c-1;f>=0&&u>=0&&a[r]===s;)n++,r-=e+1,f--,u--;if(n>=4)return!0;for(n=1,r=t+e-1,f=o+1,u=c-1;f<e&&u>=0&&a[r]===s;)n++,r+=e-1,f++,u--;for(r=t-e+1,f=o-1,u=c+1;f>=0&&u<e&&a[r]===s;)n++,r-=e+1,f--,u++;return n>=4},K=(t,s,e,o)=>{if(a[t]!==0)return{success:!1,hashDiff:0n,capturedCount:0};if(j(t,s,e))return{success:!1,hashDiff:0n,capturedCount:0};a[t]=s;let c=m[t*4+s];const n=s===1?2:1,r=q[o];r.length=0;for(let f=0;f<b;f++)a[f]===n&&(v.fill(0),F(f,n)||J(f,n,r));for(const f of r)a[f]=0,c^=m[f*4+n];if(v.fill(0),!F(t,s)){for(const f of r)a[f]=n;return a[t]=0,{success:!1,hashDiff:0n,capturedCount:0}}return{success:!0,hashDiff:c,capturedCount:r.length}},R=(t,s,e)=>{a[t]=0;const o=s===1?2:1,c=q[e];for(const n of c)a[n]=o},J=(t,s,e)=>{let o=0,c=0;const n=p;if(n[c++]=t,e.includes(t))return;e.push(t);const r=new Uint8Array(b);for(r[t]=1;o<c;){const f=n[o++];for(let u=0;u<4;u++){let h=f;for(;h=d[h*4+u],h!==-1;){const i=a[h];if(i!==0){i===s&&r[h]===0&&(r[h]=1,e.includes(h)||(e.push(h),n[c++]=h));break}}}}},V=(t,s)=>{let e=0,o=0;const c=t/2;for(let n=0;n<b;n++){const r=a[n];if(r===0||r===3)continue;let f=1e3;const u=Math.floor(n/t),h=n%t,i=Math.abs(u-c)+Math.abs(h-c);f+=(t-i)*15;for(let l=0;l<4;l++){let g=d[n*4+l],I=0;for(;g!==-1&&a[g]===0;)I++,g=d[g*4+l];f+=I*2}r===s?e+=f:o+=f}return e-o},D=t=>{const s=[];for(let e=0;e<b;e++)a[e]===0&&s.push(e);return s},P=(t,s,e)=>{const o=t/2;if(e!==0){const c=s.indexOf(e);c>0&&(s[c]=s[0],s[0]=e)}s.sort((c,n)=>{if(c===e)return-1;if(n===e)return 1;const r=Math.abs(Math.floor(c/t)-o)+Math.abs(c%t-o),f=Math.abs(Math.floor(n/t)-o)+Math.abs(n%t-o);return r-f})};let A=0,O=0,C=0;const $=(t,s,e,o)=>{if(A++,(A&1023)===0&&Date.now()>O)return-999999;const c=V(t,o);return c>=e?e:c},Z=(t,s,e,o,c,n,r)=>{if(A++,(A&1023)===0&&Date.now()>O)return-999999;const f=Number(r&X),u=M.hashes[f];let h=0;if(u===r&&M.depths[f]>=s){const w=M.scores[f],T=M.flags[f];if(h=M.bestMoves[f],T===H||(T===N?e=Math.max(e,w):T===W&&(o=Math.min(o,w)),e>=o))return w}if(s===0)return $(t,e,o,c);const i=D();P(t,i,h),n&&(C=0);let l=-1/0,g=0,I=W,G=!1;for(const w of i){const{success:T,hashDiff:x,capturedCount:z}=K(w,c,t,s);if(T){G=!0;const E=-Z(t,s-1,-o,-e,c===1?2:1,!1,r^x);if(R(w,c,s),E===999999)return-999999;if(E>l?(l=E,g=w,n&&(M.bestMoves[0]=w,C=1)):n&&E===l&&(C++,Math.random()<1/C&&(g=w,M.bestMoves[0]=w)),e=Math.max(e,l),e>=o){I=N;break}}}return G?(l!==-999999&&M.depths[f]<=s&&(M.hashes[f]=r,M.scores[f]=l,M.flags[f]=l>e&&l<o?H:I,M.depths[f]=s,M.bestMoves[f]=g),l):V(t,c)},y=async(t,s,e)=>{const o=t.length;Q(o),(!a||a.length!==o*o)&&(a=new Int8Array(o*o),v=new Uint8Array(o*o),S=new Int16Array(o*o),p=new Int16Array(o*o));for(let i=0;i<o;i++)for(let l=0;l<o;l++)a[i*o+l]=t[i][l];A=0;const c=s===L.Black?1:2,n=Y(o),r=typeof navigator<"u"&&/Mobi|Android|iPhone/i.test(navigator.userAgent);let f=100,u=2;e===B.Hard?(f=r?800:1500,u=r?4:8):e===B.Medium?(f=r?300:500,u=3):(f=100,u=1),O=Date.now()+f;let h=0;if(e===B.Easy&&Math.random()<.3){const i=D();if(i.length>0){const l=i[Math.floor(Math.random()*Math.min(i.length,5))];return _(l,o)}}for(let i=1;i<=u&&!(Z(o,i,-1/0,1/0,c,!0,n)===-999999||(M.bestMoves[0]!==0&&(h=M.bestMoves[0]),Date.now()>O-50));i++);if(h===0){const i=D();for(const l of i){const{success:g}=K(l,c,o,0);if(g)return R(l,c,0),_(l,o)}return null}return _(h,o)};self.onmessage=async t=>{const{board:s,player:e,difficulty:o}=t.data,c=await y(s,e,o);self.postMessage(c)}})();
