(function(){"use strict";var U=(t=>(t[t.None=0]="None",t[t.Black=1]="Black",t[t.White=2]="White",t[t.Obstacle=3]="Obstacle",t))(U||{}),d=(t=>(t.Easy="easy",t.Medium="medium",t.Hard="hard",t))(d||{});const D=13,Q=D*D,w=new Int16Array(Q*4);let b,H=0;const X=t=>{if(H!==t){H=t,w.fill(-1);for(let f=0;f<t;f++)for(let e=0;e<t;e++){const o=f*t+e;f>0&&(w[o*4+0]=(f-1)*t+e),f<t-1&&(w[o*4+1]=(f+1)*t+e),e>0&&(w[o*4+2]=f*t+(e-1)),e<t-1&&(w[o*4+3]=f*t+(e+1))}b=new BigUint64Array(t*t*4);for(let f=0;f<b.length;f++){const e=BigInt(Math.floor(Math.random()*4294967295)),o=BigInt(Math.floor(Math.random()*4294967295));b[f]=e<<32n|o}}},S=(t,f)=>({r:Math.floor(t/f),c:t%f});let a,g,A,N;const k=1<<20,Y=BigInt(k-1),M={hashes:new BigUint64Array(k),depths:new Int8Array(k),flags:new Uint8Array(k),scores:new Int32Array(k),bestMoves:new Int16Array(k)},C=1,F=2,W=3,Z=Array.from({length:30},()=>[]),$=t=>{let f=0n;for(let e=0;e<t*t;e++){const o=a[e];o!==0&&(f^=b[e*4+o])}return f},K=(t,f,e)=>{let o=0,c=0;for(A[c++]=t,g[t]=1;o<c;){const s=A[o++];if(f===1){let r=s,n=!1;for(;r=w[r*4+0],r!==-1;)if(a[r]!==0){n=!0;break}if(!n)return!0;for(r=s,n=!1;r=w[r*4+1],r!==-1;)if(a[r]!==0){n=!0;break}if(!n)return!0}else{let r=s,n=!1;for(;r=w[r*4+2],r!==-1;)if(a[r]!==0){n=!0;break}if(!n)return!0;for(r=s,n=!1;r=w[r*4+3],r!==-1;)if(a[r]!==0){n=!0;break}if(!n)return!0}for(let r=0;r<4;r++){let n=s;for(;n=w[n*4+r],n!==-1;){const i=a[n];if(i!==0){i===f&&g[n]!==1&&(g[n]=1,A[c++]=n);break}}}}return!1},j=(t,f,e)=>{const o=Math.floor(t/e),c=t%e;let s=1,r=t+1;for(;r%e>c&&r<e*e&&a[r]===f;)s++,r++;for(r=t-1;r%e<c&&r>=0&&a[r]===f;)s++,r--;if(s>=4)return!0;for(s=1,r=t+e;r<e*e&&a[r]===f;)s++,r+=e;for(r=t-e;r>=0&&a[r]===f;)s++,r-=e;if(s>=4)return!0;s=1,r=t+e+1;let n=o+1,i=c+1;for(;n<e&&i<e&&a[r]===f;)s++,r+=e+1,n++,i++;for(r=t-e-1,n=o-1,i=c-1;n>=0&&i>=0&&a[r]===f;)s++,r-=e+1,n--,i--;if(s>=4)return!0;for(s=1,r=t+e-1,n=o+1,i=c-1;n<e&&i>=0&&a[r]===f;)s++,r+=e-1,n++,i--;for(r=t-e+1,n=o-1,i=c+1;n>=0&&i<e&&a[r]===f;)s++,r-=e+1,n--,i++;return s>=4},R=(t,f,e,o)=>{if(a[t]!==0)return{success:!1,hashDiff:0n};if(j(t,f,e))return{success:!1,hashDiff:0n};a[t]=f;let c=b[t*4+f];const s=f===1?2:1,r=Z[o];r.length=0;for(let n=0;n<e*e;n++)a[n]===s&&(g.fill(0),K(n,s)||J(n,s,e,r));for(const n of r)a[n]=0,c^=b[n*4+s];if(g.fill(0),!K(t,f)){for(const n of r)a[n]=s;return a[t]=0,{success:!1,hashDiff:0n}}return{success:!0,hashDiff:c}},V=(t,f,e)=>{a[t]=0;const o=f===1?2:1,c=Z[e];for(const s of c)a[s]=o},J=(t,f,e,o)=>{let c=0,s=0;const r=N;if(r[s++]=t,o.includes(t))return;o.push(t);const n=new Uint8Array(e*e);for(n[t]=1;c<s;){const i=r[c++];for(let u=0;u<4;u++){let l=i;for(;l=w[l*4+u],l!==-1;){const h=a[l];if(h!==0){h===f&&n[l]===0&&(n[l]=1,o.includes(l)||(o.push(l),r[s++]=l));break}}}}},p=(t,f)=>{let e=0,o=0;const c=t/2;for(let s=0;s<t*t;s++){const r=a[s];if(r===0||r===3)continue;let n=100;const i=Math.floor(s/t),u=s%t,l=Math.abs(i-c)+Math.abs(u-c);n+=(t-l)*2;for(let h=0;h<4;h++){let v=w[s*4+h];v===-1?n+=30:a[v]===0&&(n+=2)}r===f?e+=n:o+=n}return e-o},P=(t,f,e)=>{const o=t/2;if(e!==0){const c=f.indexOf(e);c>0&&(f[c]=f[0],f[0]=e)}f.sort((c,s)=>{if(c===e)return-1;if(s===e)return 1;const r=Math.abs(Math.floor(c/t)-o)+Math.abs(c%t-o),n=Math.abs(Math.floor(s/t)-o)+Math.abs(s%t-o);return r-n})},E=t=>{const f=[];for(let e=0;e<t*t;e++)a[e]===0&&f.push(e);return f};let O=0,_=0,T=0;const q=(t,f,e,o,c,s,r)=>{if(O++,(O&2047)===0&&Date.now()>_)return-999999;const n=Number(r&Y),i=M.hashes[n];let u=0;if(i===r&&M.depths[n]>=f){const m=M.flags[n],I=M.scores[n];if(u=M.bestMoves[n],m===C||(m===F?e=Math.max(e,I):m===W&&(o=Math.min(o,I)),e>=o))return I}if(f===0)return p(t,c);const l=E(t);P(t,l,u),s&&(T=0);let h=-1/0,v=0,G=!1,L=W;for(const m of l){const{success:I,hashDiff:y}=R(m,c,t,f);if(I){G=!0;const B=-q(t,f-1,-o,-e,c===1?2:1,!1,r^y);if(V(m,c,f),B===999999)return-999999;if(B>h?(h=B,v=m,s&&(M.bestMoves[0]=m,T=1)):s&&B===h&&(T++,Math.random()<1/T&&(v=m,M.bestMoves[0]=m)),e=Math.max(e,h),e>=o){L=F;break}}}return G?(h!==-999999&&(h>e&&h<o&&(L=C),M.depths[n]<=f&&(M.hashes[n]=r,M.scores[n]=h,M.flags[n]=L,M.depths[n]=f,M.bestMoves[n]=v)),h):p(t,c)},x=async(t,f,e)=>{const o=t.length;X(o),(!a||a.length!==o*o)&&(a=new Int8Array(o*o),g=new Uint8Array(o*o),A=new Int16Array(o*o),N=new Int16Array(o*o));for(let u=0;u<o;u++)for(let l=0;l<o;l++)a[u*o+l]=t[u][l];O=0;const c=f===U.Black?1:2,s=$(o),r=e===d.Hard?1200:e===d.Medium?400:100;_=Date.now()+r;let n=-1,i=e===d.Hard?8:e===d.Medium?4:2;if(e===d.Easy&&Math.random()<.25){const u=E(o);if(u.length>0){const l=u[Math.floor(Math.random()*Math.min(u.length,8))];return S(l,o)}}console.log(`AI Thinking (${e})...`);for(let u=1;u<=i;u++){if(q(o,u,-1/0,1/0,c,!0,s)===-999999){console.log("Time out at depth",u);break}if(M.bestMoves[0]!==0&&(n=M.bestMoves[0]),Date.now()>_)break}if(n===-1||n===0){const u=E(o);for(const l of u){const{success:h}=R(l,c,o,0);if(h)return V(l,c,0),S(l,o)}return null}return S(n,o)};self.onmessage=async t=>{const{board:f,player:e,difficulty:o}=t.data,c=await x(f,e,o);self.postMessage(c)}})();
