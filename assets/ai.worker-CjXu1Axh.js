(function(){"use strict";var L=(t=>(t[t.None=0]="None",t[t.Black=1]="Black",t[t.White=2]="White",t[t.Obstacle=3]="Obstacle",t))(L||{}),I=(t=>(t.Easy="easy",t.Medium="medium",t.Hard="hard",t))(I||{});let k=169;const g=new Int16Array(2e3);let A,R=0;const J=t=>{if(R!==t){R=t,k=t*t,g.fill(-1);for(let n=0;n<t;n++)for(let o=0;o<t;o++){const e=n*t+o;n>0&&(g[e*4+0]=(n-1)*t+o),n<t-1&&(g[e*4+1]=(n+1)*t+o),o>0&&(g[e*4+2]=n*t+(o-1)),o<t-1&&(g[e*4+3]=n*t+(o+1))}A=new BigUint64Array(t*t*4);for(let n=0;n<A.length;n++){const o=BigInt(Math.floor(Math.random()*4294967295)),e=BigInt(Math.floor(Math.random()*4294967295));A[n]=o<<32n|e}}},U=(t,n)=>({r:Math.floor(t/n),c:t%n});let M,B,T;const b=1<<20,N=BigInt(b-1),v={hashes:new BigUint64Array(b),depths:new Int8Array(b),flags:new Uint8Array(b),scores:new Int32Array(b),bestMoves:new Int16Array(b)},C=1,F=2,W=3,p=Array.from({length:30},()=>[]),y=t=>{let n=0n;for(let o=0;o<t*t;o++){const e=M[o];e!==0&&(n^=A[o*4+e])}return n},K=(t,n,o)=>{let e=0,l=0;B.fill(0);for(let s=0;s<k;s++)if(M[s]===t){let r=!1;if(t===1){let f=s,c=!1;for(;f=g[f*4+0],f!==-1;)if(M[f]!==0){c=!0;break}if(!c)r=!0;else{for(f=s,c=!1;f=g[f*4+1],f!==-1;)if(M[f]!==0){c=!0;break}c||(r=!0)}}else{let f=s,c=!1;for(;f=g[f*4+2],f!==-1;)if(M[f]!==0){c=!0;break}if(!c)r=!0;else{for(f=s,c=!1;f=g[f*4+3],f!==-1;)if(M[f]!==0){c=!0;break}c||(r=!0)}}r&&(B[s]=1,T[l++]=s)}for(;e<l;){const s=T[e++];for(let r=0;r<4;r++){let f=s;for(;f=g[f*4+r],f!==-1;){const c=M[f];if(c!==0){c===t&&B[f]===0&&(B[f]=1,T[l++]=f);break}}}}for(let s=0;s<k;s++)M[s]===t&&B[s]===0&&o.push(s)},z=(t,n,o)=>{const e=Math.floor(t/o),l=t%o;let s=1,r=t+1;for(;r%o>l&&r<k&&M[r]===n;)s++,r++;for(r=t-1;r%o<l&&r>=0&&M[r]===n;)s++,r--;if(s>=4)return!0;for(s=1,r=t+o;r<k&&M[r]===n;)s++,r+=o;for(r=t-o;r>=0&&M[r]===n;)s++,r-=o;if(s>=4)return!0;s=1,r=t+o+1;let f=e+1,c=l+1;for(;f<o&&c<o&&M[r]===n;)s++,r+=o+1,f++,c++;for(r=t-o-1,f=e-1,c=l-1;f>=0&&c>=0&&M[r]===n;)s++,r-=o+1,f--,c--;if(s>=4)return!0;for(s=1,r=t+o-1,f=e+1,c=l-1;f<o&&c>=0&&M[r]===n;)s++,r+=o-1,f++,c--;for(r=t-o+1,f=e-1,c=l+1;f>=0&&c<o&&M[r]===n;)s++,r-=o+1,f--,c++;return s>=4},Y=(t,n,o,e)=>{if(M[t]!==0)return{success:!1,hashDiff:0n,capturedCount:0};if(z(t,n,o))return{success:!1,hashDiff:0n,capturedCount:0};M[t]=n;let l=A[t*4+n];const s=n===1?2:1,r=p[e];r.length=0,K(s,o,r);for(let c=0;c<r.length;c++){const i=r[c];M[i]=0,l^=A[i*4+s]}const f=[];if(K(n,o,f),f.includes(t)){for(let c=0;c<r.length;c++)M[r[c]]=s;return M[t]=0,{success:!1,hashDiff:0n,capturedCount:0}}return{success:!0,hashDiff:l,capturedCount:r.length}},Z=(t,n,o)=>{M[t]=0;const e=n===1?2:1,l=p[o];for(let s=0;s<l.length;s++)M[l[s]]=e},$=(t,n)=>{let o=0,e=0;const l=t/2;for(let s=0;s<k;s++){const r=M[s];if(r===0||r===3)continue;let f=200;const c=Math.floor(s/t),i=s%t,a=Math.abs(c-l)+Math.abs(i-l);f+=(t-a)*10,r===n?o+=f:e+=f}return n===2&&(o+=50),o-e},j=t=>{const n=[];for(let o=0;o<k;o++)M[o]===0&&n.push(o);return n},tt=(t,n,o)=>{const e=t/2;if(o!==0){const l=n.indexOf(o);l>-1&&(n[l]=n[0],n[0]=o)}n.sort((l,s)=>{if(l===o)return-1;if(s===o)return 1;const r=Math.abs(Math.floor(l/t)-e)+Math.abs(l%t-e),f=Math.abs(Math.floor(s/t)-e)+Math.abs(s%t-e);return r-f})};let _=0,q=0,S=!1;const P=(t,n,o,e,l,s)=>{if(_++,(_&2047)===0&&Date.now()>q&&(S=!0),S)return 0;const r=Number(s&N),f=v.hashes[r];let c=0;if(f===s){if(v.depths[r]>=n){const m=v.scores[r],w=v.flags[r];if(w===C||(w===F?o=Math.max(o,m):w===W&&(e=Math.min(e,m)),o>=e))return m}c=v.bestMoves[r]}if(n<=0)return $(t,l);const i=j();tt(t,i,c);let a=-1/0,u=0,h=W,d=!1;for(const m of i){const{success:w,hashDiff:ft}=Y(m,l,t,n);if(w){d=!0;const G=-P(t,n-1,-e,-o,l===1?2:1,s^ft);if(Z(m,l,n),S)return 0;if(G>a&&(a=G,u=m),o=Math.max(o,a),o>=e){h=F;break}}}return d?(S||(v.hashes[r]=s,v.scores[r]=a,v.flags[r]=a>o&&a<e?C:h,v.depths[r]=n,v.bestMoves[r]=u),a):$(t,l)},nt=async(t,n,o)=>{const e=t.length;J(e),(!M||M.length!==e*e)&&(M=new Int8Array(e*e),B=new Uint8Array(e*e),T=new Int16Array(e*e));for(let u=0;u<e;u++)for(let h=0;h<e;h++)M[u*e+h]=t[u][h];_=0,S=!1;const l=n===L.Black?1:2,s=y(e),r=typeof navigator<"u"&&/Mobi|Android|iPhone/i.test(navigator.userAgent);let f=r?500:1e3;o===I.Hard&&(f=r?1200:2500),q=Date.now()+f;let c=0,i=-1/0;const a=20;for(let u=1;u<=a&&(P(e,u,-1/0,1/0,l,s),!S);u++){const h=Number(s&N);if(v.hashes[h]===s&&(c=v.bestMoves[h],i=v.scores[h]),Math.abs(i)>5e3)break}if(c===0&&M[0]!==0){const u=j();for(const h of u){const{success:d}=Y(h,l,e,0);if(d)return Z(h,l,0),U(h,e)}return null}return U(c,e)},ot=t=>{const n=t.length,o=new Int8Array(n*n);for(let e=0;e<n;e++)for(let l=0;l<n;l++)o[e*n+l]=t[e][l];return o},E=(t,n,o)=>t*o+n,x=(t,n)=>({r:Math.floor(t/n),c:t%n}),O={},et=t=>{if(O[t])return;const n=[],o=[[-1,0],[1,0],[0,-1],[0,1]];for(let e=0;e<t;e++)for(let l=0;l<t;l++){const s=E(e,l,t);n[s]=[],o.forEach(([r,f],c)=>{const i=e+r,a=l+f;i>=0&&i<t&&a>=0&&a<t?n[s][c]=E(i,a,t):n[s][c]=-1})}O[t]=n},Q=(t,n,o)=>{const e=[],l=new Uint8Array(n*n),s=[],r=O[n];for(let c=0;c<n*n;c++)if(t[c]===o){let i=!1;const a=o===1?[0,1]:[2,3];for(const u of a){let h=!0,d=c;for(;d=r[d][u],d!==-1;)if(t[d]!==0){h=!1;break}if(h){i=!0;break}}i&&(s.push(c),l[c]=1)}let f=0;for(;f<s.length;){const c=s[f++];for(let i=0;i<4;i++){let a=c;for(;a=r[a][i],a!==-1;){const u=t[a];if(u!==0){u===o&&l[a]===0&&(l[a]=1,s.push(a));break}}}}for(let c=0;c<n*n;c++)t[c]===o&&l[c]===0&&e.push(c);return e},rt=(t,n,o,e)=>{const l=Math.floor(o/n),s=o%n,r=[[0,1],[1,0],[1,1],[1,-1]];for(const[f,c]of r){let i=1,a=l+f,u=s+c;for(;a>=0&&a<n&&u>=0&&u<n&&t[a*n+u]===e;)i++,a+=f,u+=c;for(a=l-f,u=s-c;a>=0&&a<n&&u>=0&&u<n&&t[a*n+u]===e;)i++,a-=f,u-=c;if(i>=4)return!0}return!1},D=(t,n,o,e)=>{if(t[o]!==0||rt(t,n,o,e))return null;const l=new Int8Array(t);l[o]=e;const r=Q(l,n,e===1?2:1);for(const c of r)l[c]=0;return Q(l,n,e).includes(o)?null:l},V=(t,n,o)=>{let e=0;const l=n/2;for(let s=0;s<n;s++)for(let r=0;r<n;r++){const f=E(s,r,n),c=t[f];if(c===0||c===3)continue;const i=Math.abs(s-l)+Math.abs(r-l),a=n-i;c===o?e+=100+a:e-=100+a}return e},X=(t,n,o)=>{const e=new Set,l=O[n];(n===13?[[3,3],[3,9],[9,3],[9,9],[6,6]]:[[3,3],[3,8],[8,3],[8,8]]).forEach(([f,c])=>{const i=E(f,c,n);t[i]===0&&e.add(i)});for(let f=0;f<n*n;f++)if(t[f]!==0&&t[f]!==3){const c=Math.floor(f/n),i=f%n;for(let a=-1;a<=1;a++)for(let u=-1;u<=1;u++){if(a===0&&u===0)continue;const h=c+a,d=i+u;if(h>=0&&h<n&&d>=0&&d<n){const m=E(h,d,n);t[m]===0&&e.add(m)}}[0,1,2,3].forEach(a=>{let u=f,h=l[u][a];if(h!==-1&&t[h]===0){u=h;for(let d=0;d<3&&(u=l[u][a],u!==-1&&t[u]===0);d++)e.add(u)}})}const r=n/2;return Array.from(e).sort((f,c)=>{const i=Math.abs(Math.floor(f/n)-r)+Math.abs(f%n-r),a=Math.abs(Math.floor(c/n)-r)+Math.abs(c%n-r);return i-a})},H=(t,n,o,e,l,s,r)=>{if(o===0)return V(t,n,r);const f=X(t,n);if(f.length===0)return V(t,n,r);if(s){let c=-1/0;for(const i of f){const a=D(t,n,i,r);if(!a)continue;const u=H(a,n,o-1,e,l,!1,r);if(c=Math.max(c,u),e=Math.max(e,u),l<=e)break}return c}else{const c=r===1?2:1;let i=1/0;for(const a of f){const u=D(t,n,a,c);if(!u)continue;const h=H(u,n,o-1,e,l,!0,r);if(i=Math.min(i,h),l=Math.min(l,h),l<=e)break}return i}},ct=async(t,n,o)=>{const e=t.length;et(e);const l=ot(t),s=n===L.Black?1:2;let r=1;o===I.Easy&&(r=1),o===I.Medium&&(r=2),o===I.Hard&&(r=4);const f=X(l,e);let c=-1,i=-1/0;if(o===I.Easy&&f.length>0&&Math.random()<.3){const a=Math.floor(Math.random()*Math.min(5,f.length));return x(f[a],e)}for(const a of f){const u=D(l,e,a,s);if(!u)continue;const h=s===1?2:1;let d=0;for(let w=0;w<e*e;w++)u[w]===h&&d++;if(d===0)return x(a,e);const m=H(u,e,r-1,-1/0,1/0,!1,s);m>i&&(i=m,c=a)}return c===-1?null:x(c,e)};self.onmessage=async t=>{const{board:n,player:o,difficulty:e}=t.data;let l;e===I.Hard?l=await nt(n,o,e):l=await ct(n,o,e),self.postMessage(l)}})();
