(function(){"use strict";var u=(e=>(e[e.None=0]="None",e[e.Black=1]="Black",e[e.White=2]="White",e))(u||{}),m=(e=>(e[e.Success=0]="Success",e[e.Occupied=1]="Occupied",e[e.Overload=2]="Overload",e[e.Suicide=3]="Suicide",e[e.Ko=4]="Ko",e))(m||{}),B=(e=>(e.Easy="easy",e.Medium="medium",e.Hard="hard",e))(B||{});const w=13,I=[[-1,0],[1,0],[0,-1],[0,1]],x=[[[0,1],[0,-1]],[[1,0],[-1,0]],[[1,1],[-1,-1]],[[1,-1],[-1,1]]],M=(e,c)=>e>=0&&e<w&&c>=0&&c<w,p=(e,c,f,o)=>{const l=[];if(o===u.Black){let s=!0;for(let t=c-1;t>=0;t--)if(e[t][f]!==u.None){s=!1;break}s&&l.push({row:0,col:f});let n=!0;for(let t=c+1;t<w;t++)if(e[t][f]!==u.None){n=!1;break}n&&l.push({row:w-1,col:f})}else if(o===u.White){let s=!0;for(let t=f-1;t>=0;t--)if(e[c][t]!==u.None){s=!1;break}s&&l.push({row:c,col:0});let n=!0;for(let t=f+1;t<w;t++)if(e[c][t]!==u.None){n=!1;break}n&&l.push({row:c,col:w-1})}return l},O=(e,c,f,o)=>{for(const l of x){let s=1;for(const[n,t]of l){let r=c+n,a=f+t;for(;M(r,a)&&e[r][a]===o;)s++,r+=n,a+=t}if(s>=4)return!0}return!1},C=(e,c,f)=>{const o=e[c][f];if(o===u.None)return[];const l=[];for(const[s,n]of I){let t=c+s,r=f+n;for(;M(t,r);){const a=e[t][r];if(a===u.None){t+=s,r+=n;continue}else if(a===o){l.push({row:t,col:r});break}else break}}return l},v=(e,c)=>{const f=[],o=new Set,l=[];for(let n=0;n<w;n++)for(let t=0;t<w;t++)e[n][t]===c&&p(e,n,t,c).length>0&&(l.push({row:n,col:t}),o.add(`${n},${t}`));let s=0;for(;s<l.length;){const{row:n,col:t}=l[s++],r=C(e,n,t);for(const a of r){const i=`${a.row},${a.col}`;o.has(i)||(o.add(i),l.push(a))}}for(let n=0;n<w;n++)for(let t=0;t<w;t++)e[n][t]===c&&!o.has(`${n},${t}`)&&f.push({row:n,col:t});return f},k=(e,c,f,o,l)=>{if(!M(c,f)||e[c][f]!==u.None)return{result:m.Occupied};if(O(e,c,f,o))return{result:m.Overload};const s=e.map(i=>[...i]);s[c][f]=o;const n=o===u.Black?u.White:u.Black,t=v(s,n);t.forEach(i=>{s[i.row][i.col]=u.None});const r=v(s,o);return r.some(i=>i.row===c&&i.col===f)?{result:m.Suicide}:(r.forEach(i=>{s[i.row][i.col]=u.None}),{result:m.Success,newBoard:s,captured:[...t,...r]})},W=e=>{const c=[],f=new Map,o=new Map,l=(s,n,t,r)=>{let a=s+t,i=n+r;for(;M(a,i);){if(e[a][i]===u.None){a+=t,i+=r;continue}return{row:a,col:i}}return null};for(let s=0;s<w;s++)for(let n=0;n<w;n++){const t=e[s][n];if(t===u.None)continue;const r=`${s},${n}`;o.has(r)||o.set(r,0);const a=[[0,1],[1,0]];for(const[i,d]of a){const h=l(s,n,i,d);if(h&&e[h.row][h.col]===t){c.push([{row:s,col:n},h,t]),o.set(r,(o.get(r)||0)+1);const g=`${h.row},${h.col}`;o.set(g,(o.get(g)||0)+1)}}}for(let s=0;s<w;s++)for(let n=0;n<w;n++){const t=e[s][n];if(t===u.None)continue;const r=p(e,s,n,t);let a=!1;r.length>0&&(a=!0,r.forEach(h=>{(h.row!==s||h.col!==n)&&c.push([{row:s,col:n},h,t])}));const i=o.get(`${s},${n}`)||0,d=!a&&i<=1;f.set(`${s},${n}`,{isRoot:a,isFragile:d})}return{connections:c,statuses:f}},D=2,A=12,N=(e,c)=>{c===u.Black?u.White:u.Black;const f=W(e);let o=0,l=0,s=0;for(let n=0;n<w;n++)for(let t=0;t<w;t++){const r=e[n][t];if(r===u.None)continue;const a=`${n},${t}`,i=f.statuses.get(a),d=r===c,h=100,g=Math.abs(n-6)+Math.abs(t-6),S=Math.max(0,10-g);d?(l++,o+=h+S,i!=null&&i.isRoot&&(o+=30),i!=null&&i.isFragile&&(o-=60)):(s++,o-=h+S,i!=null&&i.isRoot&&(o-=30),i!=null&&i.isFragile&&(o+=60))}return s===0&&l>0?1e6:l===0&&s>0?-1e6:(f.connections.forEach(([n,t,r])=>{r===c?o+=5:o-=5}),o)},E=(e,c)=>{const f=[];for(let o=0;o<w;o++)for(let l=0;l<w;l++)if(e[o][l]===u.None){const{result:s}=k(e,o,l,c);s===m.Success&&f.push({r:o,c:l})}return f},$=(e,c,f,o,l,s)=>{const n=s===u.Black?u.White:u.Black;if(c===0)return N(e,s);const t=l?s:n,r=E(e,t);if(r.length===0)return N(e,s);let a=r.map(d=>{const{newBoard:h,captured:g}=k(e,d.r,d.c,t);let S=0;g&&g.length>0&&(S+=1e3*g.length);const H=Math.abs(d.r-6)+Math.abs(d.c-6);return S-=H,{move:d,newBoard:h,heuristic:S}});a.sort((d,h)=>h.heuristic-d.heuristic);const i=a.slice(0,A);if(l){let d=-1/0;for(const h of i){if(!h.newBoard)continue;const g=$(h.newBoard,c-1,f,o,!1,s);if(d=Math.max(d,g),f=Math.max(f,g),o<=f)break}return d}else{let d=1/0;for(const h of i){if(!h.newBoard)continue;const g=$(h.newBoard,c-1,f,o,!0,s);if(d=Math.min(d,g),o=Math.min(o,g),o<=f)break}return d}},F=async(e,c,f)=>{const o=E(e,c);if(o.length===0)return null;if(f===B.Easy){const l=Math.floor(Math.random()*o.length);return o[l]}if(f===B.Medium){let l=o[0],s=-1/0;const n=o.sort(()=>.5-Math.random());for(const t of n){const{newBoard:r,captured:a}=k(e,t.r,t.c,c);if(r){let i=N(r,c);a&&(i+=a.length*50),i>s&&(s=i,l=t)}}return l}if(f===B.Hard){let l=o[0],s=-1/0;const n=o.map(r=>{const{newBoard:a,captured:i}=k(e,r.r,r.c,c);let d=-1/0;return a&&(d=N(a,c),i&&(d+=i.length*200)),{move:r,newBoard:a,immediateScore:d}});n.sort((r,a)=>a.immediateScore-r.immediateScore);const t=n.slice(0,16);for(const r of t){if(!r.newBoard)continue;const a=$(r.newBoard,D-1,-1/0,1/0,!1,c);a>s&&(s=a,l=r.move)}return l}return o[0]};self.onmessage=async e=>{const{board:c,player:f,difficulty:o}=e.data,l=await F(c,f,o);self.postMessage(l)}})();
