(function(){"use strict";var O=(n=>(n[n.None=0]="None",n[n.Black=1]="Black",n[n.White=2]="White",n[n.Obstacle=3]="Obstacle",n))(O||{}),k=(n=>(n.Easy="easy",n.Medium="medium",n.Hard="hard",n))(k||{});let S=169;const v=new Int16Array(2e3);let w,H=0;const G=n=>{if(H!==n){H=n,S=n*n,v.fill(-1);for(let t=0;t<n;t++)for(let o=0;o<n;o++){const e=t*n+o;t>0&&(v[e*4+0]=(t-1)*n+o),t<n-1&&(v[e*4+1]=(t+1)*n+o),o>0&&(v[e*4+2]=t*n+(o-1)),o<n-1&&(v[e*4+3]=t*n+(o+1))}w=new BigUint64Array(n*n*4);for(let t=0;t<w.length;t++){const o=BigInt(Math.floor(Math.random()*4294967295)),e=BigInt(Math.floor(Math.random()*4294967295));w[t]=o<<32n|e}}},R=(n,t)=>({r:Math.floor(n/t),c:n%t});let d,A,E;const b=1<<20,U=BigInt(b-1),g={hashes:new BigUint64Array(b),depths:new Int8Array(b),flags:new Uint8Array(b),scores:new Int32Array(b),bestMoves:new Int16Array(b)},N=1,y=2,C=3,F=Array.from({length:30},()=>[]),J=n=>{let t=0n;for(let o=0;o<n*n;o++){const e=d[o];e!==0&&(t^=w[o*4+e])}return t},z=(n,t,o)=>{const e=Math.floor(n/o),s=n%o,l=[[0,1],[1,0],[1,1],[1,-1]];for(const[c,r]of l){let f=1,u=e+c,a=s+r;for(;u>=0&&u<o&&a>=0&&a<o&&d[u*o+a]===t;)f++,u+=c,a+=r;for(u=e-c,a=s-r;u>=0&&u<o&&a>=0&&a<o&&d[u*o+a]===t;)f++,u-=c,a-=r;if(f>=4)return!0}return!1},W=(n,t,o)=>{let e=0,s=0;A.fill(0);for(let l=0;l<S;l++)if(d[l]===n){let c=!1;if(n===1){let r=l,f=!1;for(;r=v[r*4+0],r!==-1;)if(d[r]!==0){f=!0;break}if(!f)c=!0;else{for(r=l,f=!1;r=v[r*4+1],r!==-1;)if(d[r]!==0){f=!0;break}f||(c=!0)}}else{let r=l,f=!1;for(;r=v[r*4+2],r!==-1;)if(d[r]!==0){f=!0;break}if(!f)c=!0;else{for(r=l,f=!1;r=v[r*4+3],r!==-1;)if(d[r]!==0){f=!0;break}f||(c=!0)}}c&&(A[l]=1,E[s++]=l)}for(;e<s;){const l=E[e++];for(let c=0;c<4;c++){let r=l;for(;r=v[r*4+c],r!==-1;){const f=d[r];if(f!==0){f===n&&A[r]===0&&(A[r]=1,E[s++]=r);break}}}}for(let l=0;l<S;l++)d[l]===n&&A[l]===0&&o.push(l)},K=(n,t,o,e)=>{if(d[n]!==0)return{success:!1,hashDiff:0n,capturedCount:0};if(z(n,t,o))return{success:!1,hashDiff:0n,capturedCount:0};d[n]=t;let s=w[n*4+t];const l=t===1?2:1,c=F[e];c.length=0,W(l,o,c);for(let f=0;f<c.length;f++){const u=c[f];d[u]=0,s^=w[u*4+l]}const r=[];if(W(t,o,r),r.includes(n)){for(let f=0;f<c.length;f++)d[c[f]]=l;return d[n]=0,{success:!1,hashDiff:0n,capturedCount:0}}return{success:!0,hashDiff:s,capturedCount:c.length}},Y=(n,t,o)=>{d[n]=0;const e=t===1?2:1,s=F[o];for(let l=0;l<s.length;l++)d[s[l]]=e},Z=(n,t)=>{let o=0,e=0;const s=n/2;for(let l=0;l<S;l++){const c=d[l];if(c===0||c===3)continue;let r=200;const f=Math.floor(l/n),u=l%n,a=Math.abs(f-s)+Math.abs(u-s);r+=(n-a)*10;for(let i=0;i<4;i++){let h=v[l*4+i];h!==-1&&d[h]===0&&(r+=5,h=v[h*4+i],h!==-1&&d[h]===0&&(r+=2))}c===t?o+=r:e+=r}return t===2&&(o+=50),o-e},$=n=>{const t=[];for(let o=0;o<S;o++)d[o]===0&&t.push(o);return t},tt=(n,t,o)=>{const e=n/2;if(o!==0){const c=t.indexOf(o);c>-1&&(t[c]=t[0],t[0]=o)}const s=Math.floor(t.length/3),l=t.slice(0,s);t.slice(s),l.sort((c,r)=>{if(c===o)return-1;if(r===o)return 1;const f=Math.abs(Math.floor(c/n)-e)+Math.abs(c%n-e),u=Math.abs(Math.floor(r/n)-e)+Math.abs(r%n-e);return f-u});for(let c=0;c<l.length;c++)t[c]=l[c]};let L=0,j=0,B=!1;const q=(n,t,o,e,s,l)=>{if(L++,(L&2047)===0&&Date.now()>j&&(B=!0),B)return 0;const c=Number(l&U),r=g.hashes[c];let f=0;if(r===l){if(g.depths[c]>=t){const m=g.scores[c],I=g.flags[c];if(I===N||(I===y?o=Math.max(o,m):I===C&&(e=Math.min(e,m)),o>=e))return m}f=g.bestMoves[c]}if(t<=0)return Z(n,s);const u=$();tt(n,u,f);let a=-1/0,i=0,h=C,M=!1;for(const m of u){const{success:I,hashDiff:ft}=K(m,s,n,t);if(I){M=!0;const X=-q(n,t-1,-e,-o,s===1?2:1,l^ft);if(Y(m,s,t),B)return 0;if(X>a&&(a=X,i=m),o=Math.max(o,a),o>=e){h=y;break}}}return M?(B||(g.hashes[c]=l,g.scores[c]=a,g.flags[c]=a>o&&a<e?N:h,g.depths[c]=t,g.bestMoves[c]=i),a):Z(n,s)},nt=async(n,t,o)=>{const e=n.length;G(e),(!d||d.length!==e*e)&&(d=new Int8Array(e*e),A=new Uint8Array(e*e),E=new Int16Array(e*e));for(let i=0;i<e;i++)for(let h=0;h<e;h++)d[i*e+h]=n[i][h];L=0,B=!1;const s=t===O.Black?1:2,l=J(e),c=typeof navigator<"u"&&/Mobi|Android|iPhone/i.test(navigator.userAgent);let r=c?800:1500;o===k.Hard&&(r=c?1200:2500),j=Date.now()+r;let f=0,u=-1/0;const a=20;for(let i=1;i<=a&&(q(e,i,-1/0,1/0,s,l),!B);i++){const h=Number(l&U);if(g.hashes[h]===l&&(f=g.bestMoves[h],u=g.scores[h]),Math.abs(u)>5e3)break}if(d[f]!==0){const i=$();for(const h of i){const{success:M}=K(h,s,e,0);if(M)return Y(h,s,0),R(h,e)}return null}return R(f,e)},et=n=>{const t=n.length,o=new Int8Array(t*t);for(let e=0;e<t;e++)for(let s=0;s<t;s++)o[e*t+s]=n[e][s];return o},x=(n,t,o)=>n*o+t,_=(n,t)=>({r:Math.floor(n/t),c:n%t}),T={},ot=n=>{if(T[n])return;const t=[],o=[[-1,0],[1,0],[0,-1],[0,1]];for(let e=0;e<n;e++)for(let s=0;s<n;s++){const l=x(e,s,n);t[l]=[],o.forEach(([c,r],f)=>{const u=e+c,a=s+r;u>=0&&u<n&&a>=0&&a<n?t[l][f]=x(u,a,n):t[l][f]=-1})}T[n]=t},P=(n,t,o)=>{const e=[],s=new Uint8Array(t*t),l=[],c=T[t];for(let f=0;f<t*t;f++)if(n[f]===o){let u=!1;const a=o===1?[0,1]:[2,3];for(const i of a){let h=!0,M=f;for(;M=c[M][i],M!==-1;)if(n[M]!==0){h=!1;break}if(h){u=!0;break}}u&&(l.push(f),s[f]=1)}let r=0;for(;r<l.length;){const f=l[r++];for(let u=0;u<4;u++){let a=f;for(;a=c[a][u],a!==-1;){const i=n[a];if(i!==0){i===o&&s[a]===0&&(s[a]=1,l.push(a));break}}}}for(let f=0;f<t*t;f++)n[f]===o&&s[f]===0&&e.push(f);return e},rt=(n,t,o,e)=>{const s=Math.floor(o/t),l=o%t,c=[[0,1],[1,0],[1,1],[1,-1]];for(const[r,f]of c){let u=1,a=s+r,i=l+f;for(;a>=0&&a<t&&i>=0&&i<t&&n[a*t+i]===e;)u++,a+=r,i+=f;for(a=s-r,i=l-f;a>=0&&a<t&&i>=0&&i<t&&n[a*t+i]===e;)u++,a-=r,i-=f;if(u>=4)return!0}return!1},p=(n,t,o,e)=>{if(n[o]!==0||rt(n,t,o,e))return null;const s=new Int8Array(n);s[o]=e;const c=P(s,t,e===1?2:1);for(const f of c)s[f]=0;return P(s,t,e).includes(o)?null:s},Q=(n,t,o)=>{let e=0;const s=t/2;for(let l=0;l<t;l++)for(let c=0;c<t;c++){const r=x(l,c,t),f=n[r];if(f===0||f===3)continue;const u=Math.abs(l-s)+Math.abs(c-s),a=t-u;f===o?e+=100+a:e-=100+a}return e},V=(n,t,o)=>{const e=new Set,s=T[t];(t===13?[[3,3],[3,9],[9,3],[9,9],[6,6]]:[[3,3],[3,8],[8,3],[8,8]]).forEach(([r,f])=>{const u=x(r,f,t);n[u]===0&&e.add(u)});for(let r=0;r<t*t;r++)if(n[r]!==0&&n[r]!==3){const f=Math.floor(r/t),u=r%t;for(let a=-1;a<=1;a++)for(let i=-1;i<=1;i++){if(a===0&&i===0)continue;const h=f+a,M=u+i;if(h>=0&&h<t&&M>=0&&M<t){const m=x(h,M,t);n[m]===0&&e.add(m)}}[0,1,2,3].forEach(a=>{let i=r,h=s[i][a];if(h!==-1&&n[h]===0){i=h;for(let M=0;M<3&&(i=s[i][a],i!==-1&&n[i]===0);M++)e.add(i)}})}const c=t/2;return Array.from(e).sort((r,f)=>{const u=Math.abs(Math.floor(r/t)-c)+Math.abs(r%t-c),a=Math.abs(Math.floor(f/t)-c)+Math.abs(f%t-c);return u-a})},D=(n,t,o,e,s,l,c)=>{if(o===0)return Q(n,t,c);const r=V(n,t);if(r.length===0)return Q(n,t,c);if(l){let f=-1/0;for(const u of r){const a=p(n,t,u,c);if(!a)continue;const i=D(a,t,o-1,e,s,!1,c);if(f=Math.max(f,i),e=Math.max(e,i),s<=e)break}return f}else{const f=c===1?2:1;let u=1/0;for(const a of r){const i=p(n,t,a,f);if(!i)continue;const h=D(i,t,o-1,e,s,!0,c);if(u=Math.min(u,h),s=Math.min(s,h),s<=e)break}return u}},ct=async(n,t,o)=>{const e=n.length;ot(e);const s=et(n),l=t===O.Black?1:2;let c=1;o===k.Easy&&(c=1),o===k.Medium&&(c=2),o===k.Hard&&(c=4);const r=V(s,e);let f=-1,u=-1/0;if(o===k.Easy&&r.length>0&&Math.random()<.3){const a=Math.floor(Math.random()*Math.min(5,r.length));return _(r[a],e)}for(const a of r){const i=p(s,e,a,l);if(!i)continue;const h=l===1?2:1;let M=0;for(let I=0;I<e*e;I++)i[I]===h&&M++;if(M===0)return _(a,e);const m=D(i,e,c-1,-1/0,1/0,!1,l);m>u&&(u=m,f=a)}return f===-1?null:_(f,e)};self.onmessage=async n=>{const{board:t,player:o,difficulty:e}=n.data;let s;e===k.Hard?s=await nt(t,o,e):s=await ct(t,o,e),self.postMessage(s)}})();
