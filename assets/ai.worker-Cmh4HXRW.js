(function(){"use strict";var W=(t=>(t[t.None=0]="None",t[t.Black=1]="Black",t[t.White=2]="White",t[t.Obstacle=3]="Obstacle",t))(W||{}),B=(t=>(t.Easy="easy",t.Medium="medium",t.Hard="hard",t.Master="master",t))(B||{});let C=169;const T=new Int16Array(2e3);let S,K=0;const ht=t=>{if(K!==t){K=t,C=t*t,T.fill(-1);for(let e=0;e<t;e++)for(let o=0;o<t;o++){const n=e*t+o;e>0&&(T[n*4+0]=(e-1)*t+o),e<t-1&&(T[n*4+1]=(e+1)*t+o),o>0&&(T[n*4+2]=e*t+(o-1)),o<t-1&&(T[n*4+3]=e*t+(o+1))}S=new BigUint64Array(t*t*4);for(let e=0;e<S.length;e++){const o=BigInt(Math.floor(Math.random()*4294967295)),n=BigInt(Math.floor(Math.random()*4294967295));S[e]=o<<32n|n}}},Q=(t,e)=>({r:Math.floor(t/e),c:t%e});let m,E,N;const O=1<<20,V=BigInt(O-1),v={hashes:new BigUint64Array(O),depths:new Int8Array(O),flags:new Uint8Array(O),scores:new Int32Array(O),bestMoves:new Int16Array(O)},X=1,q=2,j=3,J=Array.from({length:30},()=>[]),Mt=t=>{let e=0n;for(let o=0;o<t*t;o++){const n=m[o];n!==0&&(e^=S[o*4+n])}return e},dt=(t,e,o)=>{const n=Math.floor(t/o),r=t%o,f=[[0,1],[1,0],[1,1],[1,-1]];for(const[i,l]of f){let h=1,u=n+i,s=r+l;for(;u>=0&&u<o&&s>=0&&s<o&&m[u*o+s]===e;)h++,u+=i,s+=l;for(u=n-i,s=r-l;u>=0&&u<o&&s>=0&&s<o&&m[u*o+s]===e;)h++,u-=i,s-=l;if(h>=4)return!0}return!1},z=(t,e,o)=>{let n=0,r=0;E.fill(0);for(let f=0;f<C;f++)if(m[f]===t){let i=!1;if(t===1){let l=f,h=!1;for(;l=T[l*4+0],l!==-1;)if(m[l]!==0){h=!0;break}if(!h)i=!0;else{for(l=f,h=!1;l=T[l*4+1],l!==-1;)if(m[l]!==0){h=!0;break}h||(i=!0)}}else{let l=f,h=!1;for(;l=T[l*4+2],l!==-1;)if(m[l]!==0){h=!0;break}if(!h)i=!0;else{for(l=f,h=!1;l=T[l*4+3],l!==-1;)if(m[l]!==0){h=!0;break}h||(i=!0)}}i&&(E[f]=1,N[r++]=f)}for(;n<r;){const f=N[n++];for(let i=0;i<4;i++){let l=f;for(;l=T[l*4+i],l!==-1;){const h=m[l];if(h!==0){h===t&&E[l]===0&&(E[l]=1,N[r++]=l);break}}}}for(let f=0;f<C;f++)m[f]===t&&E[f]===0&&o.push(f)},tt=(t,e,o,n)=>{if(m[t]!==0)return{success:!1,hashDiff:0n,capturedCount:0};if(dt(t,e,o))return{success:!1,hashDiff:0n,capturedCount:0};m[t]=e;let r=S[t*4+e];const f=e===1?2:1,i=J[n];i.length=0,z(f,o,i);for(let h=0;h<i.length;h++){const u=i[h];m[u]=0,r^=S[u*4+f]}const l=[];if(z(e,o,l),l.includes(t)){for(let h=0;h<i.length;h++)m[i[h]]=f;return m[t]=0,{success:!1,hashDiff:0n,capturedCount:0}}return{success:!0,hashDiff:r,capturedCount:i.length}},et=(t,e,o)=>{m[t]=0;const n=e===1?2:1,r=J[o];for(let f=0;f<r.length;f++)m[r[f]]=n},nt=(t,e)=>{let o=0,n=0;const r=t/2;for(let f=0;f<C;f++){const i=m[f];if(i===0||i===3)continue;let l=200;const h=Math.floor(f/t),u=f%t,s=Math.abs(h-r)+Math.abs(u-r);l+=(t-s)*10;for(let c=0;c<4;c++){let a=T[f*4+c];a!==-1&&m[a]===0&&(l+=5,a=T[a*4+c],a!==-1&&m[a]===0&&(l+=2))}i===e?o+=l:n+=l}return e===2&&(o+=0),o-n},ot=t=>{const e=[];for(let o=0;o<C;o++)m[o]===0&&e.push(o);return e},gt=(t,e,o)=>{const n=t/2;if(o!==0){const i=e.indexOf(o);i>-1&&(e[i]=e[0],e[0]=o)}const r=Math.floor(e.length/3),f=e.slice(0,r);e.slice(r),f.sort((i,l)=>{if(i===o)return-1;if(l===o)return 1;const h=Math.abs(Math.floor(i/t)-n)+Math.abs(i%t-n),u=Math.abs(Math.floor(l/t)-n)+Math.abs(l%t-n);return h-u});for(let i=0;i<f.length;i++)e[i]=f[i]};let Y=0,rt=0,H=!1;const ft=(t,e,o,n,r,f)=>{if(Y++,(Y&2047)===0&&Date.now()>rt&&(H=!0),H)return 0;const i=Number(f&V),l=v.hashes[i];let h=0;if(l===f){if(v.depths[i]>=e){const M=v.scores[i],g=v.flags[i];if(g===X||(g===q?o=Math.max(o,M):g===j&&(n=Math.min(n,M)),o>=n))return M}h=v.bestMoves[i]}if(e<=0)return nt(t,r);const u=ot();gt(t,u,h);let s=-1/0,c=0,a=j,d=!1;for(const M of u){const{success:g,hashDiff:k}=tt(M,r,t,e);if(g){d=!0;const A=-ft(t,e-1,-n,-o,r===1?2:1,f^k);if(et(M,r,e),H)return 0;if(A>s&&(s=A,c=M),o=Math.max(o,s),o>=n){a=q;break}}}return d?(H||(v.hashes[i]=f,v.scores[i]=s,v.flags[i]=s>o&&s<n?X:a,v.depths[i]=e,v.bestMoves[i]=c),s):nt(t,r)},mt=async(t,e,o)=>{const n=t.length;ht(n),(!m||m.length!==n*n)&&(m=new Int8Array(n*n),E=new Uint8Array(n*n),N=new Int16Array(n*n));for(let c=0;c<n;c++)for(let a=0;a<n;a++)m[c*n+a]=t[c][a];Y=0,H=!1;const r=e===W.Black?1:2,f=Mt(n),i=typeof navigator<"u"&&/Mobi|Android|iPhone/i.test(navigator.userAgent);let l=2e3;o===B.Hard?l=i?2e3:3500:o===B.Master&&(l=1e4),rt=Date.now()+l;let h=0,u=-1/0;const s=o===B.Master?99:20;for(let c=1;c<=s&&(ft(n,c,-1/0,1/0,r,f),!H);c++){const a=Number(f&V);if(v.hashes[a]===f&&(h=v.bestMoves[a],u=v.scores[a]),Math.abs(u)>5e3)break}if(m[h]!==0){const c=ot();for(const a of c){const{success:d}=tt(a,r,n,0);if(d)return et(a,r,0),Q(a,n)}return null}return Q(h,n)},It=t=>{const e=t.length,o=new Int8Array(e*e);for(let n=0;n<e;n++)for(let r=0;r<e;r++)o[n*e+r]=t[n][r];return o},x=(t,e,o)=>t*o+e,st=(t,e)=>({r:Math.floor(t/e),c:t%e}),R={},_={},ct=t=>{if(!R[t]){const e=[],o=[[-1,0],[1,0],[0,-1],[0,1]];for(let n=0;n<t;n++)for(let r=0;r<t;r++){const f=x(n,r,t);e[f]=[],o.forEach(([i,l],h)=>{const u=n+i,s=r+l;u>=0&&u<t&&s>=0&&s<t?e[f][h]=x(u,s,t):e[f][h]=-1})}R[t]=e}if(!_[t]){const e=t*t,o=[];for(let n=0;n<e;n++){const r=new BigUint64Array(3);r[1]=BigInt(Math.floor(Math.random()*4294967295))<<32n|BigInt(Math.floor(Math.random()*4294967295)),r[2]=BigInt(Math.floor(Math.random()*4294967295))<<32n|BigInt(Math.floor(Math.random()*4294967295)),o.push(r)}_[t]=o}},kt=(t,e)=>{let o=0n;_[e]||ct(e);const n=_[e];for(let r=0;r<e*e;r++){const f=t[r];(f===1||f===2)&&(o^=n[r][f])}return o},$=new Map,lt=0,p=1,D=2;let F=null,it=null;const wt=t=>{const e=t*t;(!F||F.length<e)&&(F=new Uint8Array(e),it=new Int16Array(e))},at=(t,e,o)=>{wt(e);const n=F,r=it;n.fill(0);const f=[];let i=0,l=0;const h=R[e],u=e===19;for(let s=0;s<e*e;s++)if(t[s]===o){let c=!1;if(o===1){let a=s,d=!1;for(;a=h[a][0],a!==-1;)if(t[a]!==0){d=!0;break}if(!d)c=!0;else{for(a=s,d=!1;a=h[a][1],a!==-1;)if(t[a]!==0){d=!0;break}d||(c=!0)}if(u&&!c){let M=s,g=!1;for(;M=h[M][2],M!==-1;)if(t[M]!==0){g=!0;break}if(!g)c=!0;else{for(M=s,g=!1;M=h[M][3],M!==-1;)if(t[M]!==0){g=!0;break}g||(c=!0)}}}else{let a=s,d=!1;for(;a=h[a][2],a!==-1;)if(t[a]!==0){d=!0;break}if(!d)c=!0;else{for(a=s,d=!1;a=h[a][3],a!==-1;)if(t[a]!==0){d=!0;break}d||(c=!0)}if(u&&!c){let M=s,g=!1;for(;M=h[M][0],M!==-1;)if(t[M]!==0){g=!0;break}if(!g)c=!0;else{for(M=s,g=!1;M=h[M][1],M!==-1;)if(t[M]!==0){g=!0;break}g||(c=!0)}}}c&&(r[l++]=s,n[s]=1)}for(;i<l;){const s=r[i++];for(let c=0;c<4;c++){let a=s;for(;a=h[a][c],a!==-1;){const d=t[a];if(d!==0){d===o&&n[a]===0&&(n[a]=1,r[l++]=a);break}}}}for(let s=0;s<e*e;s++)t[s]===o&&n[s]===0&&f.push(s);return f},vt=(t,e,o,n)=>{const r=Math.floor(o/e),f=o%e,i=[[0,1],[1,0],[1,1],[1,-1]];for(const[l,h]of i){let u=1,s=r+l,c=f+h;for(;s>=0&&s<e&&c>=0&&c<e&&t[s*e+c]===n;)u++,s+=l,c+=h;for(s=r-l,c=f-h;s>=0&&s<e&&c>=0&&c<e&&t[s*e+c]===n;)u++,s-=l,c-=h;if(u>=4)return!0}return!1},y=(t,e,o,n,r)=>{if(t[n]!==0||vt(t,o,n,r))return null;const f=new Int8Array(t);f[n]=r;let i=e^_[o][n][r];const l=r===1?2:1,h=at(f,o,l);for(const s of h)f[s]=0,i^=_[o][s][l];return at(f,o,r).includes(n)?null:{board:f,hash:i}},G=(t,e,o)=>{let n=0;const r=e/2,f=R[e],i=200,l=3,h=5,u=30,s=-25;for(let c=0;c<e*e;c++){const a=t[c];if(a===0||a===3)continue;let d=i;const M=Math.floor(c/e),g=c%e,k=Math.abs(M-r)+Math.abs(g-r);d+=(e-k)*l;let A=0,U=!1;const P=a===1,I=P?[0,1]:[2,3];for(let w=0;w<4;w++){let b=c;if(b=f[b][w],b===-1)I.includes(w)&&(U=!0);else if(t[b]===0){A++;let L=f[b][w];L!==-1&&t[L]===0&&(A+=.5)}else t[b]===(P?2:1)?d+=15:d+=5}U&&(d+=u),A<1.5&&!U&&(d+=s),d+=A*h,a===o?n+=d:n-=d}return n},ut=(t,e,o)=>{const n=[],r=e/2,f=new Uint8Array(e),i=new Uint8Array(e);let l=0;for(let u=0;u<e*e;u++)(t[u]===1||t[u]===2)&&(f[Math.floor(u/e)]=1,i[u%e]=1,l++);if(l===0)return n.push(x(Math.floor(r),Math.floor(r),e)),(e===13?[[3,3],[3,9],[9,3],[9,9]]:[[3,3],[3,8],[8,3],[8,8]]).forEach(([s,c])=>n.push(x(s,c,e))),n;for(let u=0;u<e*e;u++)if(t[u]===0){const s=Math.floor(u/e),c=u%e;let a=!1,d=!1;const M=1;for(let g=s-M;g<=s+M&&!d;g++)for(let k=c-M;k<=c+M;k++)if(g>=0&&g<e&&k>=0&&k<e){const A=g*e+k;if(t[A]===1||t[A]===2){d=!0,a=!0;break}}a||(f[s]===1||i[c]===1)&&(a=!0),a&&n.push(u)}const h=u=>{const s=R[e];for(let c=0;c<4;c++){const a=s[u][c];if(a!==-1&&t[a]!==0&&t[a]!==3)return!0}return!1};return n.sort((u,s)=>{const c=h(u),a=h(s);if(c&&!a)return-1;if(!c&&a)return 1;const d=Math.abs(Math.floor(u/e)-r)+Math.abs(u%e-r),M=Math.abs(Math.floor(s/e)-r)+Math.abs(s%e-r);return d-M})},Z=(t,e,o,n,r,f,i,l,h)=>{const u=$.get(e);if(u&&u.depth>=n&&(u.flag===lt||(u.flag===p?r=Math.max(r,u.score):u.flag===D&&(f=Math.min(f,u.score)),r>=f)))return u.score;if(n===0)return G(t,o,l);let s=ut(t,o);if(s.length>h&&(s=s.slice(0,h)),s.length===0)return G(t,o,l);let c=i?-1/0:1/0,a=i?D:p;if(i)for(const d of s){const M=y(t,e,o,d,l);if(!M)continue;const g=Z(M.board,M.hash,o,n-1,r,f,!1,l,h);if(g>c&&(c=g),r=Math.max(r,c),f<=r)break}else{const d=l===1?2:1;for(const M of s){const g=y(t,e,o,M,d);if(!g)continue;const k=Z(g.board,g.hash,o,n-1,r,f,!0,l,h);if(k<c&&(c=k),f=Math.min(f,c),f<=r)break}}return Math.abs(c)===1/0&&(c=G(t,o,l)),c>r&&c<f?a=lt:i&&c<=r?a=D:i&&c>=f||!i&&c>=f?a=p:!i&&c<=r&&(a=D),$.set(e,{depth:n,score:c,flag:a}),c},At=async(t,e,o)=>{const n=t.length;ct(n),$.size>2e5&&$.clear();const r=It(t),f=kt(r,n),i=e===W.Black?1:2;let l=0,h=0;for(let I=0;I<n*n;I++)r[I]===0?l++:r[I]!==3&&h++;let u=2,s=40,c=60;o===B.Medium&&(u=4,l<30?(u=6,s=999):l<60&&(u=5,s=32),G(r,n,i)<-350&&h>10&&(u=Math.min(u+1,6),s=24));let a=ut(r,n);a.length>c&&(a=a.slice(0,c));const d=i===1?2:1;for(const I of a){const w=y(r,0n,n,I,i);if(!w)continue;let b=0;for(let L=0;L<n*n;L++)w.board[L]===d&&b++;if(b===0)return st(I,n)}let M=[];for(const I of a){const w=y(r,f,n,I,i);if(!w)continue;const b=Z(w.board,w.hash,n,u-1,-1/0,1/0,!1,i,s);M.push({id:I,score:b})}if(M.length===0)return null;M.sort((I,w)=>w.score-I.score);const g=M[0].score,k=25,A=M.filter(I=>I.score>=g-k),U=Math.floor(Math.random()*A.length),P=A[U].id;return st(P,n)};self.onmessage=async t=>{const{board:e,player:o,difficulty:n}=t.data;let r;n===B.Hard||n===B.Master?r=await mt(e,o,n):r=await At(e,o,n),self.postMessage(r)}})();
